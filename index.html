"use client"

import { useState, useEffect } from "react"

interface Channel {
  id: string
  target: string
}

const channels: Channel[] = [
  { id: "denverracingsocial", target: "broadcast" },
  { id: "drscentennial", target: "centennial" },
  { id: "drswatsonmills", target: "lafayette" },
  { id: "denverracingsocialmu1", target: "mu1" },
]

export default function DRSTwitchPage() {
  const [activeTab, setActiveTab] = useState<string>("broadcast")

  const activateTab = (targetId: string) => {
    setActiveTab(targetId)
  }

  // Twitch API Auto-Detect Live Streams
  const checkLiveChannels = async () => {
    const clientId = "6lwz7yvyfmlccmybi4vkbqhootlyrw"
    const clientSecret = "jr8in3gfdb4sg26mdhrbqrz6lu16dc"

    try {
      // Get App Access Token
      const tokenRes = await fetch(
        `https://id.twitch.tv/oauth2/token?client_id=${clientId}&client_secret=${clientSecret}&grant_type=client_credentials`,
        {
          method: "POST",
        },
      )
      const tokenData = await tokenRes.json()
      const accessToken = tokenData.access_token

      // Build query for all channels
      const loginParams = channels.map((c) => `user_login=${c.id}`).join("&")

      const liveRes = await fetch(`https://api.twitch.tv/helix/streams?${loginParams}`, {
        headers: {
          "Client-ID": clientId,
          Authorization: `Bearer ${accessToken}`,
        },
      })

      const liveData = await liveRes.json()
      const liveIds = new Set(liveData.data.map((s: any) => s.user_login))

      // Find the first live channel by priority
      let liveTarget = null
      for (const c of channels) {
        if (liveIds.has(c.id)) {
          liveTarget = c.target
          break
        }
      }

      if (liveTarget) {
        activateTab(liveTarget)
      } else {
        activateTab("broadcast") // default if none live
      }
    } catch (err) {
      console.error("Twitch API Error:", err)
      activateTab("broadcast") // fallback
    }
  }

  useEffect(() => {
    checkLiveChannels()
  }, [])

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-100 via-gray-50 to-blue-50 relative overflow-hidden">
      {/* Light gradient overlay */}
      <div className="absolute inset-0 bg-gradient-to-br from-blue-50/50 via-white/30 to-slate-100/50"></div>

      <div className="relative z-10">
        {/* Logo Section */}
        <div className="pt-10 pb-4 px-5 text-center">
          <div className="inline-block p-4 bg-white/80 backdrop-blur-md rounded-3xl border border-gray-200/50 shadow-xl hover:bg-white/90 transition-all duration-500">
            <img
              src="https://static.wixstatic.com/media/8c955c_1f0a3e74b34a462b92387217a91541ca~mv2.png"
              alt="Denver Racing Social Logo"
              className="w-28 h-auto"
            />
          </div>
          <h1 className="mt-6 text-2xl md:text-3xl font-bold text-gray-900 tracking-tight">
            Denver Racing Social Live Streams
          </h1>
        </div>

        {/* Top Navigation Buttons with Apple Design */}
        <div className="px-5 pb-8">
          <div className="max-w-4xl mx-auto bg-white/80 backdrop-blur-xl rounded-[2rem] border border-gray-200/50 shadow-2xl p-8 hover:bg-white/90 transition-all duration-500">
            <div className="flex flex-col md:flex-row gap-4 items-center justify-center">
              <a
                href="https://www.denverracingsocial.com"
                target="_blank"
                className="px-8 py-3 bg-gray-100/80 hover:bg-gray-200/80 backdrop-blur-sm rounded-full border border-gray-300/50 text-gray-800 font-medium text-sm transition-all duration-300 hover:scale-105 hover:border-gray-400/50 hover:shadow-lg"
                rel="noreferrer"
              >
                ‚Üê Back to DRS Website
              </a>

              <a
                href="https://www.denverracingsocial.com/mrutoday"
                target="_blank"
                className="px-10 py-4 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-semibold text-sm rounded-full shadow-2xl transition-all duration-300 hover:scale-105 hover:shadow-blue-500/30 animate-pulse"
                rel="noreferrer"
              >
                üèÜ Sign Up - Mobile Racing Unit
              </a>

              <a
                href="https://www.denverracingsocial.com/mrutoday"
                target="_blank"
                className="px-8 py-3 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-400 hover:to-red-400 text-white font-semibold text-xs rounded-full shadow-xl transition-all duration-300 hover:scale-105 hover:shadow-orange-500/30 border-2 border-orange-400/50"
                rel="noreferrer"
              >
                üìä Position & Leaderboard
              </a>
            </div>

            {/* Additional emphasis for QR code users */}
            <div className="mt-6 text-center">
              <p className="text-gray-600 text-xs font-medium">
                Scanned our QR code? Click the blue button above to join the racing queue!
              </p>
            </div>
          </div>
        </div>

        {/* Tabs Section with Apple Design */}
        <div className="px-5 pb-8">
          <div className="max-w-6xl mx-auto bg-white/80 backdrop-blur-xl rounded-[2rem] border border-gray-200/50 shadow-2xl p-8 hover:bg-white/90 transition-all duration-500">
            <div className="flex flex-wrap justify-center gap-3 mb-8">
              {[
                { target: "broadcast", label: "üé• DRS Main Broadcast" },
                { target: "centennial", label: "üèéÔ∏è Centennial Clubhouse" },
                { target: "lafayette", label: "üèé Lafayette Clubhouse" },
                { target: "mu1", label: "üèÜ Mobile Racing Unit" },
              ].map((tab) => (
                <button
                  key={tab.target}
                  onClick={() => activateTab(tab.target)}
                  className={`px-5 py-2 text-xs font-medium rounded-full transition-all duration-300 border ${
                    activeTab === tab.target
                      ? "bg-gray-900 text-white border-gray-900 shadow-lg scale-105"
                      : "bg-white/80 text-gray-800 border-gray-300/50 hover:bg-gray-100/80 hover:scale-105 hover:border-gray-400/50 backdrop-blur-sm"
                  }`}
                >
                  {tab.label}
                </button>
              ))}
            </div>

            <div className="bg-gray-900/90 backdrop-blur-sm rounded-3xl border border-gray-300/30 p-6 shadow-xl">
              {/* Broadcast Player */}
              {activeTab === "broadcast" && (
                <iframe
                  src="https://player.twitch.tv/?channel=denverracingsocial&parent=denverracingsocial.github.io"
                  allowFullScreen
                  className="w-full h-[60vh] min-h-[340px]"
                />
              )}

              {/* Centennial Player */}
              {activeTab === "centennial" && (
                <iframe
                  src="https://player.twitch.tv/?channel=drscentennial&parent=denverracingsocial.github.io"
                  allowFullScreen
                  className="w-full h-[60vh] min-h-[340px]"
                />
              )}

              {/* Lafayette Player */}
              {activeTab === "lafayette" && (
                <iframe
                  src="https://player.twitch.tv/?channel=drswatsonmills&parent=denverracingsocial.github.io"
                  allowFullScreen
                  className="w-full h-[60vh] min-h-[340px]"
                />
              )}

              {/* Mobile Racing Unit Player */}
              {activeTab === "mu1" && (
                <iframe
                  src="https://player.twitch.tv/?channel=denverracingsocialmu1&parent=denverracingsocial.github.io"
                  allowFullScreen
                  className="w-full h-[60vh] min-h-[340px]"
                />
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}
